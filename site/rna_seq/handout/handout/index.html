



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="This contains all material for the Introduction to NGS workshop.">
      
      
      
        <meta name="author" content="Sonika Tyagi">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.2">
    
    
      
        <title>RNA-Seq - Introduction to NGS Workshop</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../css/details.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#key-learning-outcomes" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Introduction to NGS Workshop" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Introduction to NGS Workshop
            </span>
            <span class="md-header-nav__topic">
              
                RNA-Seq
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Introduction to NGS Workshop" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Introduction to NGS Workshop
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../trainers/trainers/" title="The Trainers" class="md-nav__link">
      The Trainers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../preamble/preamble/" title="Workshop Information" class="md-nav__link">
      Workshop Information
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Hands-on Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Hands-on Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../login/login/" title="Loging to the training VM" class="md-nav__link">
      Loging to the training VM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../R/Rhandout/" title="Introduction to R" class="md-nav__link">
      Introduction to R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cli/handout/handout/" title="Introduction to Command Line" class="md-nav__link">
      Introduction to Command Line
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../qc/handout/handout/" title="Quality Control" class="md-nav__link">
      Quality Control
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../alignment/handout/handout/" title="Read Alignment" class="md-nav__link">
      Read Alignment
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        RNA-Seq
      </label>
    
    <a href="./" title="RNA-Seq" class="md-nav__link md-nav__link--active">
      RNA-Seq
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-learning-outcomes" class="md-nav__link">
    Key Learning Outcomes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#author-information" class="md-nav__link">
    Author Information
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources-youll-be-using" class="md-nav__link">
    Resources You’ll be Using
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools-used" class="md-nav__link">
    Tools Used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sources-of-data" class="md-nav__link">
    Sources of Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-the-environment" class="md-nav__link">
    Prepare the Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alignment" class="md-nav__link">
    Alignment
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alignment-visualisation-in-igv" class="md-nav__link">
    Alignment Visualisation in IGV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-gene-counts" class="md-nav__link">
    Generating Gene Counts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#isoform-expression-and-transcriptome-assembly" class="md-nav__link">
    Isoform Expression and Transcriptome Assembly
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visulaizing-transcript-assembly" class="md-nav__link">
    Visulaizing transcript assembly
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#differential-gene-expression-analysis-using-edger" class="md-nav__link">
    Differential Gene Expression Analysis using edgeR
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#experiment-design" class="md-nav__link">
    Experiment Design
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-environment_1" class="md-nav__link">
    Prepare the Environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-in-data" class="md-nav__link">
    Read in Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-gene-annotation" class="md-nav__link">
    Add Gene annotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-checks" class="md-nav__link">
    Data checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-for-differential-expression" class="md-nav__link">
    Testing for Differential Expression
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denovo/handout/handout/" title="De Novo Genome Assembly" class="md-nav__link">
      De Novo Genome Assembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denovo-canu/handout/handout/" title="De Novo Canu" class="md-nav__link">
      De Novo Canu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-learning-outcomes" class="md-nav__link">
    Key Learning Outcomes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#author-information" class="md-nav__link">
    Author Information
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources-youll-be-using" class="md-nav__link">
    Resources You’ll be Using
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools-used" class="md-nav__link">
    Tools Used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sources-of-data" class="md-nav__link">
    Sources of Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-the-environment" class="md-nav__link">
    Prepare the Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alignment" class="md-nav__link">
    Alignment
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alignment-visualisation-in-igv" class="md-nav__link">
    Alignment Visualisation in IGV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-gene-counts" class="md-nav__link">
    Generating Gene Counts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#isoform-expression-and-transcriptome-assembly" class="md-nav__link">
    Isoform Expression and Transcriptome Assembly
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visulaizing-transcript-assembly" class="md-nav__link">
    Visulaizing transcript assembly
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#differential-gene-expression-analysis-using-edger" class="md-nav__link">
    Differential Gene Expression Analysis using edgeR
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#experiment-design" class="md-nav__link">
    Experiment Design
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-environment_1" class="md-nav__link">
    Prepare the Environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-in-data" class="md-nav__link">
    Read in Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-gene-annotation" class="md-nav__link">
    Add Gene annotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-checks" class="md-nav__link">
    Data checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-for-differential-expression" class="md-nav__link">
    Testing for Differential Expression
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>RNA-Seq</h1>
                
                <h2 id="key-learning-outcomes">Key Learning Outcomes</h2>
<p>After completing this practical the trainee should be able to:</p>
<ul>
<li>
<p>Understand and perform a two condition RNA-Seq expression analysis workflow.</p>
</li>
<li>
<p>Perform spliced alignments to an indexed reference genome using
    TopHat.</p>
</li>
<li>
<p>Visualize spliced transcript alignments in a genome browser such as
    IGV.</p>
</li>
<li>
<p>Be able to identify differential gene expression between two
    experimental conditions.</p>
</li>
</ul>
<p>We also have bonus exercises where you can learn to:</p>
<ul>
<li>
<p>Perform transcript assembly using Stringtie.</p>
<p>analysis.</p>
</li>
<li>
<p>Visualize transcript alignments and annotation in a genome browser
    such as IGV.</p>
</li>
</ul>
<h2 id="author-information">Author Information</h2>
<p><em>Primary Author(s):</em>
Sonika Tyagi, Monash University and  Susan Corley, UNSW</p>
<p><em>Contributor)s)</em>
Myrto Kostadima EBI UK</p>
<h2 id="resources-youll-be-using">Resources You’ll be Using</h2>
<h3 id="tools-used">Tools Used</h3>
<p>Tophat
:   <a href="https://ccb.jhu.edu/software/tophat/index.shtml">https://ccb.jhu.edu/software/tophat/index.shtml</a></p>
<p>Stringtie
:  <a href="http://https://ccb.jhu.edu/software/stringtie/">http://https://ccb.jhu.edu/software/stringtie/</a></p>
<p>Samtools
:    <a href="http://www.htslib.org/">http://www.htslib.org/</a></p>
<p>BEDTools
:   <a href="https://github.com/arq5x/bedtools2">https://github.com/arq5x/bedtools2</a></p>
<p>UCSC tools
:    <a href="http://hgdownload.cse.ucsc.edu/admin/exe/">http://hgdownload.cse.ucsc.edu/admin/exe/</a></p>
<p>IGV
:   <a href="http://www.broadinstitute.org/igv/">http://www.broadinstitute.org/igv/</a></p>
<p>FeatureCount
:    <a href="http://subread.sourceforge.net/">http://subread.sourceforge.net/</a></p>
<p>edgeR pakcage
:    <a href="https://bioconductor.org/packages/release/bioc/html/edgeR.html">https://bioconductor.org/packages/release/bioc/html/edgeR.html</a></p>
<h3 id="sources-of-data">Sources of Data</h3>
<p><a href="http://www.ebi.ac.uk/ena/data/view/ERR022484">http://www.ebi.ac.uk/ena/data/view/ERR022484</a>\
<a href="http://www.ebi.ac.uk/ena/data/view/ERR022485">http://www.ebi.ac.uk/ena/data/view/ERR022485</a>\
<a href="http://www.pnas.org/content/suppl/2008/12/16/0807121105.DCSupplemental">http://www.pnas.org/content/suppl/2008/12/16/0807121105.DCSupplemental</a></p>
<h2 id="introduction">Introduction</h2>
<p>The goal of this hands-on session is to perform some basic tasks in the
downstream analysis of RNA-seq data.\</p>
<p>First we will use RNA-seq data from zebrafish. You will align one set of
reads to the zebrafish using Tophat2. You will then view the aligned
reads using the IGV viewer. We will also demonstrate how gene counts can
be derived from this data. You will go on to assembly a transcriptome
from the read data using cufflinks. We will show you how this type of
data may be analysed for differential expression.</p>
<p>The second part of the tutorial will focus on RNA-seq data from a human
experiment (cancer cell line versus normal cells). You will use the
Bioconductor packages edgeR and voom (limma) to determine differential
gene expression. The results from this analysis will then be used in the
final session which introduces you to some of the tools used to gain
biological insight into the results of a differential expression
analysis</p>
<h2 id="prepare-the-environment">Prepare the Environment</h2>
<p>We will use a dataset derived from sequencing of mRNA from <code class="codehilite"><span class="n">Danio</span> <span class="n">rerio</span></code>
embryos in two different developmental stages. Sequencing was performed
on the Illumina platform and generated 76bp paired-end sequence data
using polyA selected RNA. Due to the time constraints of the practical
we will only use a subset of the reads.</p>
<p>The data files are contained in the subdirectory called <code class="codehilite"><span class="k">data</span></code> and are
the following:</p>
<p><code class="codehilite"><span class="mi">2</span><span class="n">cells_1</span><span class="p">.</span><span class="n">fastq</span></code> and <code class="codehilite"><span class="mi">2</span><span class="n">cells_2</span><span class="p">.</span><span class="n">fastq</span></code>
:   \
    These files are based on RNA-seq data of a 2-cell zebrafish embryo</p>
<p><code class="codehilite"><span class="mi">6</span><span class="n">h_1</span><span class="p">.</span><span class="n">fastq</span></code> and <code class="codehilite"><span class="mi">6</span><span class="n">h_2</span><span class="p">.</span><span class="n">fastq</span></code>
:   \
    These files are based on RNA-seq data of zebrafish embryos 6h post
    fertilization</p>
<p>Open the Terminal and go to the <code class="codehilite"><span class="n">rnaseq</span></code> working directory:</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /home/trainee/rnaseq/ 
</pre></div>

<p>All commands entered into the terminal for this tutorial should be from
within the <strong><code class="codehilite"><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trainee</span><span class="o">/</span><span class="n">rnaseq</span></code></strong> directory.</p>
<p>Check that the <code class="codehilite"><span class="k">data</span></code> directory contains the above-mentioned files by
typing:</p>
<p><code class="codehilite"><span class="n">shell</span><span class="n">ls</span> <span class="k">data</span></code></p>
<h2 id="alignment">Alignment</h2>
<p>There are numerous tools for performing short read alignment and the
choice of aligner should be carefully made according to the analysis
goals/requirements. Here we will use Tophat2, a widely used ultrafast
aligner that performs spliced alignments.</p>
<p>Tophat2 is based on the Bowtie2 aligner and uses an indexed genome for
the alignment to speed up the alignment and keep its memory footprint
small. The the index for the <code class="codehilite"><span class="n">Danio</span> <span class="n">rerio</span></code> genome has been created for
you.</p>
<p>The command to create an index is as follows. You DO NOT need to run
this command yourself - we have done this for you.</p>
<div class="admonition failure">
<p class="admonition-title">STOP</p>
<p><strong>DO NOT run this command. This has already been run for you.</strong>
    bowtie2-build genome/Danio_rerio.Zv9.66.dna.fa genome/ZV9</p>
</div>
<p>Tophat2 has a number of parameters in order to perform the alignment. To
view them all type:</p>
<div class="codehilite"><pre><span></span>tophat2 --help
</pre></div>

<p>The general format of the tophat2 command is:</p>
<div class="codehilite"><pre><span></span>tophat2 <span class="o">[</span>options<span class="o">]</span>* &lt;index_base&gt; &lt;reads_1&gt; &lt;reads_2&gt;
</pre></div>

<p>Where the last two arguments are the <code class="codehilite"><span class="na">.fastq</span></code> files of the paired end
reads, and the argument before is the basename of the indexed genome.</p>
<p>The quality values in the FASTQ files used in this hands-on session are
Phred+33 encoded. We explicitly tell tophat of this fact by using the
command line argument <code class="codehilite"><span class="err">–</span><span class="n">solexa</span><span class="o">-</span><span class="n">quals</span></code>.</p>
<p>You can look at the first few reads in the file <code class="codehilite"><span class="k">data</span><span class="o">/</span><span class="mi">2</span><span class="n">cells_1</span><span class="p">.</span><span class="n">fastq</span></code>
with:</p>
<p><div class="codehilite"><pre><span></span>head -n <span class="m">20</span> data/2cells_1.fastq
</pre></div>
Some other parameters that we are going to use to run Tophat are listed
below:</p>
<ul>
<li><code class="codehilite"><span class="o">-</span><span class="k">g</span></code> : Maximum number of multihits allowed. Short reads are likely to map
    to more than one location in the genome even though these reads can
    have originated from only one of these regions. In RNA-seq we allow
    for a limited number of multihits, and in this case we ask Tophat to
    report only reads that map at most onto 2 different loci.</li>
<li>
<p><code class="codehilite"><span class="err">–</span><span class="n">library</span><span class="o">-</span><span class="k">type</span></code>:   Before performing any type of RNA-seq analysis you need to know a
    few things about the library preparation. Was it done using a
    strand-specific protocol or not? If yes, which strand? In our data
    the protocol was NOT strand specific.</p>
</li>
<li>
<p><code class="codehilite"><span class="o">-</span><span class="n">j</span></code>:   Improve spliced alignment by providing Tophat with annotated splice
    junctions. Pre-existing genome annotation is an advantage when
    analysing RNA-seq data. This file contains the coordinates of
    annotated splice junctions from Ensembl. These are stored under the
    sub-directory <code class="codehilite"><span class="n">annotation</span></code> in a file called <code class="codehilite"><span class="n">ZV9</span><span class="p">.</span><span class="n">spliceSites</span></code>.</p>
</li>
<li>
<p><code class="codehilite"><span class="o">-</span><span class="n">o</span></code>:  This specifies in which subdirectory Tophat should save the output
    files. Given that for every run the name of the output files is the
    same, we specify different directories for each run.</p>
</li>
</ul>
<p>It takes some time (approx. 20 min) to perform tophat spliced
alignments, even for this subset of reads. Therefore, we have
pre-aligned the <code class="codehilite"><span class="mi">2</span><span class="n">cells</span></code> data for you using the following command:</p>
<div class="admonition failure">
<p class="admonition-title">STOP</p>
<p><strong>DO NOT run this command. This has already been run for you.</strong>
    tophat2 &ndash;solexa-quals -g 2 &ndash;library-type fr-unstranded -j annotation/Danio_rerio.Zv9.66.spliceSites -o tophat/ZV9_2cells genome/ZV9 data/2cells_1.fastq data/2cells_2.fastq</p>
</div>
<p>Align the <code class="codehilite"><span class="mi">6</span><span class="n">h</span></code> data yourself using the following command:</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># Takes approx. 20mins</span>
    tophat2 --solexa-quals -g <span class="m">2</span> --library-type fr-unstranded -j annotation/Danio_rerio.Zv9.66.spliceSites -o tophat/ZV9_6h genome/ZV9 data/6h_1.fastq data/6h_2.fastq
</pre></div>

<p>The <code class="codehilite"><span class="mi">6</span><span class="n">h</span></code> read alignment will take approx. 20 min to complete. Therefore,
we’ll take a look at some of the files, generated by tophat, for the
pre-computed <code class="codehilite"><span class="mi">2</span><span class="n">cells</span></code> data.</p>
<p>Tophat generates several files in the specified output directory. The
most important files are listed below.</p>
<p><code class="codehilite"><span class="n">accepted_hits</span><span class="p">.</span><span class="n">bam</span></code>
:   This file contains the list of read alignments in BAM format.</p>
<p><code class="codehilite"><span class="n">align_summary</span><span class="p">.</span><span class="n">txt</span></code>
:   Provides a detailed summary of the read-alignments.</p>
<p><code class="codehilite"><span class="n">unmapped</span><span class="p">.</span><span class="n">bam</span></code>
:   This file contains the unmapped reads.</p>
<p>The complete documentation can be found at:
<a href="https://ccb.jhu.edu/software/tophat/manual.shtml">https://ccb.jhu.edu/software/tophat/manual.shtml</a></p>
<h3 id="alignment-visualisation-in-igv">Alignment Visualisation in IGV</h3>
<p>The Integrative Genomics Viewer (IGV) is able to provide a visualisation
of read alignments given a reference sequence and a BAM file. We’ll
visualise the information contained in the <code class="codehilite"><span class="n">accepted_hits</span><span class="p">.</span><span class="n">bam</span></code> and
<code class="codehilite"><span class="n">junctions</span><span class="p">.</span><span class="n">bed</span></code> files for the pre-computed <code class="codehilite"><span class="mi">2</span><span class="n">cells</span></code> data. The former,
contains the tophat spliced alignments of the reads to the reference
while the latter stores the coordinates of the splice junctions present
in the data set.</p>
<p>Open the <code class="codehilite"><span class="n">rnaseq</span></code> directory on your Desktop and double-click the
<code class="codehilite"><span class="n">tophat</span></code> subdirectory and then the <code class="codehilite"><span class="n">ZV9_2cells</span></code> directory.</p>
<ol>
<li>
<p>Launch IGV by double-clicking the “IGV 2.3.*” icon on the Desktop
    (ignore any warnings that you may get as it opens). <em>NOTE: IGV may
    take several minutes to load for the first time, please be patient.</em></p>
</li>
<li>
<p>Choose “Zebrafish (Zv9)” from the drop-down box in the top left of
    the IGV window. Else you can also load the genome fasta file.</p>
</li>
<li>
<p>Load the <code class="codehilite"><span class="n">accepted_hits</span><span class="p">.</span><span class="n">sorted</span><span class="p">.</span><span class="n">bam</span></code> file by clicking the “File”
    menu, selecting “Load from File” and navigating to the
    <code class="codehilite"><span class="n">Desktop</span><span class="o">/</span><span class="n">rnaseq</span><span class="o">/</span><span class="n">tophat</span><span class="o">/</span><span class="n">ZV9_2cells</span></code> directory.</p>
</li>
<li>
<p>Rename the track by right-clicking on its name and choosing “Rename
    Track”. Give it a meaningful name like “2cells BAM”.</p>
</li>
<li>
<p>Load the <code class="codehilite"><span class="n">junctions</span><span class="p">.</span><span class="n">bed</span></code> from the same directory and rename the
    track “2cells Junctions BED”.</p>
</li>
<li>
<p>Load the Ensembl annotations file <code class="codehilite"><span class="n">Danio_rerio</span><span class="p">.</span><span class="n">Zv9</span><span class="p">.</span><span class="mi">66</span><span class="p">.</span><span class="n">gtf</span></code> stored in
    the <code class="codehilite"><span class="n">rnaseq</span><span class="o">/</span><span class="n">annotation</span></code> directory.</p>
</li>
<li>
<p>Navigate to a region on chromosome 12 by typing
    <code class="codehilite"><span class="n">chr12</span><span class="o">:</span><span class="mi">20</span><span class="o">,</span><span class="mi">270</span><span class="o">,</span><span class="mi">921</span><span class="o">-</span><span class="mi">20</span><span class="o">,</span><span class="mi">300</span><span class="o">,</span><span class="mi">943</span></code> into the search box at the top of the
    IGV window.</p>
</li>
</ol>
<p>Keep zooming to view the bam file alignments</p>
<p>Some useful IGV manuals can be found below</p>
<p><a href="http://www.broadinstitute.org/software/igv/interpreting_insert_size">http://www.broadinstitute.org/software/igv/interpreting_insert_size</a>\
<a href="http://www.broadinstitute.org/software/igv/alignmentdata">http://www.broadinstitute.org/software/igv/alignmentdata</a></p>
<p>Does the file ’align_summary.txt’ look interesting? What information
does it provide?</p>
<p>As the name suggests, the file provides a details summary of the
alignment statistics.</p>
<p>One other important file is ’unmapped.bam’. This file contains the
unampped reads.</p>
<p>Can you identify the splice junctions from the BAM file?</p>
<p>Splice junctions can be identified in the alignment BAM files. These are
the aligned RNA-Seq reads that have skipped-bases from the reference
genome (most likely introns).</p>
<p>Are the junctions annotated for <code class="codehilite"><span class="n">CBY1</span></code> consistent with the annotation?</p>
<p>Read alignment supports an extended length in exon 5 to the gene model
(cby1-001)</p>
<p>Once tophat finishes aligning the 6h data you will need to sort the
alignments found in the BAM file and then index the sorted BAM file.</p>
<div class="codehilite"><pre><span></span>samtools sort tophat/ZV9_6h/accepted_hits.bam tophat/ZV9_6h/accepted_hits.sorted
samtools index tophat/ZV9_6h/accepted_hits.sorted.bam
</pre></div>

<p>Load the sorted BAM file into IGV, as described previously, and rename
the track appropriately.</p>
<h3 id="generating-gene-counts">Generating Gene Counts</h3>
<p>In RNAseq experiments the digital gene expression is recorded as the
gene counts or number of reads aligning to a known gene feature. If you
have a well annotated genome, you can use the gene structure file in a
standard gene annotation format (GTF or GFF)) along with the spliced
alignment file to quantify the known genes. We will demonstrate a
utility called <code class="codehilite"><span class="n">FeatureCounts</span></code> that comes with the <code class="codehilite"><span class="n">Subread</span></code> package.</p>
<div class="codehilite"><pre><span></span>mkdir gene_counts
featureCounts -a annotation/Danio_rerio.Zv9.66.gtf -t exon -g gene_id -o gene_counts/gene_counts.txt tophat/ZV9_6h/accepted_hits.sorted.bam tophat/ZV9_2cells/accepted_hits.sorted.bam
</pre></div>

<h2 id="isoform-expression-and-transcriptome-assembly">Isoform Expression and Transcriptome Assembly</h2>
<p>For non-model organisms and genomes with draft assemblies and incomplete
annotations, it is a common practice to take and assembly based approach
to generate gene structures followed by the quantification step. There
are a number of reference based transcript assemblers available that can
be used for this purpose such as, cufflinks, stringtie. These assemblers
can give gene or isoform level assemblies that can be used to perform a
gene/isoform level quantification. These assemblers require an alignment
of reads with a reference genome or transcriptome as an input. The
second optional input is a known gene structure in <code class="codehilite"><span class="n">GTF</span></code> or <code class="codehilite"><span class="n">GFF</span></code>
format.</p>
<p>These gene annotation files contain information of known genes and may be helpful in reconstruction of transcripts that are of low abundance on your sample. StringTie will also assemble and construct a transcriptome containing any unannotated genes. Furthermore, its output data is able to directly be utilised in differential expression resources such as Cuffdiff, Ballgown or other packers in R (edgeR, DESeq2).</p>
<p>To run string tie, the basic command is:</p>
<p>Stringtie has a number of parameters in order to perform transcriptome
assembly and quantification. To view them all type:</p>
<div class="codehilite"><pre><span></span><span class="n">stringtie</span> <span class="c1">--help</span>
</pre></div>


<p>We aim to reconstruct the transcriptome for both samples by using the
Ensembl annotation as a guide. </p>
<p>The Ensembl annotation for <code class="codehilite"><span class="n">Danio</span> <span class="n">rerio</span></code> is available in
<code class="codehilite"><span class="n">annotation</span><span class="o">/</span><span class="n">Danio_rerio</span><span class="p">.</span><span class="n">Zv9</span><span class="p">.</span><span class="mi">66</span><span class="p">.</span><span class="n">gtf</span></code>.</p>
<p>The general format of the <code class="codehilite"><span class="n">stringtie</span></code> command is:</p>
<div class="codehilite"><pre><span></span><span class="n">stringtie</span><span class="w"> </span><span class="o">&lt;</span><span class="n">aligned_reads_file</span><span class="p">.</span><span class="n">bam</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">options</span><span class="o">]</span><span class="w"></span>
</pre></div>


<p>Where the input is the aligned reads (either in SAM or BAM format).</p>
<p>Perform transcriptome assembly, strictly using the supplied GTF
annotations, for the <code class="codehilite"><span class="mi">2</span><span class="n">cells</span></code> and <code class="codehilite"><span class="mi">6</span><span class="n">h</span></code> data using cufflinks:</p>
<p>For instance, to run StringTie on 2cells BAM file:</p>
<div class="codehilite"><pre><span></span><span class="n">stringtie</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8</span> <span class="o">-</span><span class="k">G</span> <span class="n">annotation</span><span class="o">/</span><span class="n">Danio_rerio</span><span class="p">.</span><span class="n">Zv9</span><span class="p">.</span><span class="mi">66</span><span class="p">.</span><span class="n">gtf</span> <span class="o">-</span><span class="n">o</span> <span class="n">stringtie</span><span class="o">/</span><span class="n">ZV9_2cells</span><span class="p">.</span><span class="n">gft</span> <span class="n">tophat</span><span class="o">/</span><span class="n">ZV9_2cells</span><span class="o">/</span><span class="n">accepted_hits</span><span class="p">.</span><span class="n">sorted</span><span class="p">.</span><span class="n">bam</span>
</pre></div>


<p>Repeat this command on the 6h BAM file:</p>
<div class="codehilite"><pre><span></span><span class="n">stringtie</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8</span> <span class="o">-</span><span class="k">G</span> <span class="n">annotation</span><span class="o">/</span><span class="n">Danio_rerio</span><span class="p">.</span><span class="n">Zv9</span><span class="p">.</span><span class="mi">66</span><span class="p">.</span><span class="n">gtf</span> <span class="o">-</span><span class="n">o</span> <span class="n">stringtie</span><span class="o">/</span><span class="n">ZV9_6h</span><span class="p">.</span><span class="n">gft</span> <span class="n">tophat</span><span class="o">/</span><span class="n">ZV9_6h</span><span class="o">/</span><span class="n">accepted_hits</span><span class="p">.</span><span class="n">sorted</span><span class="p">.</span><span class="n">bam</span>
</pre></div>


<p>:   -p = number of processing threads</p>
<p>:   -G = reference annotation file</p>
<p>:   -o = output file location and name.</p>
<p>Most RNA sequencing experiments will have multiple samples. As such, Stringtie has a function to merge all transcripts assembled across the samples, which enables inter-sample comparisons to be made. It does this by first assembling all transcripts within each sample, merging the the transcripts and re-running the assembly based off a merged list of genes.</p>
<p>Prior to running a merge function within stringtie:
We need to create a mergelist.txt file before utilising the merge function. This is a list of all .gtf files created by stringtie in the above step and can be made in a text editor such as vi or nano. For this exercise, there is a file pre-made for you. The txt file will direct the merge function to look for the names of all the .gtf files that we want to merge.</p>
<p>To merge StringTie files</p>
<div class="codehilite"><pre><span></span><span class="n">ls</span> <span class="n">stringtie</span><span class="cm">/*.gtf &gt;mergelist.txt</span>
<span class="cm">less mergelist.txt</span>

<span class="cm">stringtie --merge -p 8 -G annotation/Danio_rerio.Zv9.66.gtf -o stringtie/stringtie_merged.gtf mergelist.txt</span>
</pre></div>


<p>(mergelist.txt is a text file that will have a list of all .gtf generated by stringtie in the above steps)</p>
<p>Note how a reference gene annotation (Danio_rerio.Zv9.66.gtf) is utilised in this case. This makes use of information we already have in order to assemble the transcriptome of our RNA seq data.</p>
<p>The next step is an optional step to see how your merged annotation compares to reference gene annotation provided. gffcompare is a tool that determines how many of your annotations match the reference (either fully or partial) and how many were completely novel. The output of this ulitily gives you:</p>
<p>Sensitivity is defined as the proportion of genes from the annotation that are correctly reconstructed
Precision (also known as positive predictive value) captures the proportion of the output that overlaps the annotation
To compare how merged annotation compares to reference</p>
<div class="codehilite"><pre><span></span><span class="n">gffcompare</span> <span class="o">-</span><span class="k">G</span> <span class="o">-</span><span class="n">r</span> <span class="n">annotation</span><span class="o">/</span><span class="n">Danio_rerio</span><span class="p">.</span><span class="n">Zv9</span><span class="p">.</span><span class="mi">66</span><span class="p">.</span><span class="n">gtf</span> <span class="n">stringtie</span><span class="o">/</span><span class="n">stringtie_merged</span><span class="p">.</span><span class="n">gtf</span>
</pre></div>


<p>:   -r = reference genome in form of gtf</p>
<p>:   -G = tells gffcompare to compare all transcripts in the input file (stringtie/stringtie_merged.gtf), even those that might be redundant</p>
<p>:   -o = all output of gffcompare has a gffcmp. prefix, unless otherwise defined by user</p>
<p>Now that we are happy with our merged annotation, we need to estimate the abundance of each transcript within each sample. Stringtie is designed to create output files that are immediately usable in next step of our RNA sequencing pipeline. In this next example, we can direct stringtie to simultaneously create a .ctab file required for ballgown.</p>
<p>To estimate abundances and create table counts for 2cell </p>
<div class="codehilite"><pre><span></span><span class="n">stringtie</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">B</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8</span> <span class="o">-</span><span class="k">G</span> <span class="n">stringtie</span><span class="o">/</span><span class="n">stringtie_merged</span><span class="p">.</span><span class="n">gtf</span> <span class="o">-</span><span class="n">o</span> <span class="n">ballgown</span><span class="o">/</span><span class="n">ZV9_6h</span><span class="p">.</span><span class="n">gtf</span> <span class="n">tophat</span><span class="o">/</span><span class="n">ZV9_6h</span><span class="o">/</span><span class="n">accepted_hits</span><span class="p">.</span><span class="n">sorted</span><span class="p">.</span><span class="n">bam</span>
</pre></div>


<p>To estimate abundances and create table counts for 2cell </p>
<div class="codehilite"><pre><span></span><span class="n">stringtie</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">B</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8</span> <span class="o">-</span><span class="k">G</span> <span class="n">stringtie</span><span class="o">/</span><span class="n">stringtie_merged</span><span class="p">.</span><span class="n">gtf</span> <span class="o">-</span><span class="n">o</span> <span class="n">ballgown</span><span class="o">/</span><span class="n">ZV9_2cells</span><span class="p">.</span><span class="n">gtf</span> <span class="n">tophat</span><span class="o">/</span><span class="n">ZV9_2cells</span><span class="o">/</span><span class="n">accepted_hits</span><span class="p">.</span><span class="n">sorted</span><span class="p">.</span><span class="n">bam</span>
</pre></div>


<p>:   -e = limits the processing of read alignments to only estimate and output the assembled transcripts matching the reference transcripts (given by -G). Reads with no reference transcripts will be entirely skipped</p>
<p>:   -B = enables output of Ballgown input table files (*.ctab) containing coverage data for the reference transcripts given with the -G option. If -o is used,  StringTie will write the *.ctab files in the same directory as the output GTF.      </p>
<p>:   -p = refers to number of processing threads</p>
<p>:   -G = refers to a reference annotation (in GTF or GFF format)</p>
<h2 id="visulaizing-transcript-assembly">Visulaizing transcript assembly</h2>
<ol>
<li>
<p>Go back to IGV and load the pre-computed, GTF-guided transcriptome
    assembly for the <code class="codehilite"><span class="mi">2</span><span class="n">cells</span></code> data
    (<code class="codehilite"><span class="n">stringtie</span><span class="o">/</span><span class="n">ZV9_2cells</span><span class="p">.</span><span class="n">gtf</span></code>).</p>
</li>
<li>
<p>Rename the track as “2cells GTF-Guided Transcripts”.</p>
</li>
<li>
<p>In the search box type <code class="codehilite"><span class="n">ENSDART00000082297</span></code> in order for the browser
    to zoom in to the gene of interest.</p>
</li>
</ol>
<p>Do you observe any difference between the Ensembl GTF annotations and
the GTF-guided transcripts assembled by cufflinks (the “2cells
GTF-Guided Transcripts” track)?</p>
<p>Yes. It appears that the Ensembl annotations may have truncated the last
exon. However, our data also doesn’t contain reads that span between the
last two exons.</p>
<h2 id="differential-gene-expression-analysis-using-edger">Differential Gene Expression Analysis using edgeR</h2>
<h3 id="experiment-design">Experiment Design</h3>
<p>The example we are working through today follows a case Study set out in
the edgeR Users Guide (4.3 Androgen-treated prostate cancer cells
(RNA-Seq, two groups) which is based on an experiment conducted by Li et
al. (2008, Proc Natl Acad Sci USA, 105, 20179-84).</p>
<p>The researches used a prostate cancer cell line (LNCaP cells). These
cells are sensitive to stimulation by male hormones (androgens). Three
replicate RNA samples were collected from LNCaP cells treated with an
androgen hormone (DHT). Four replicates were collected from cells
treated with an inactive compound. Each of the seven samples was run on
a lane (7 lanes) of an Illumina flow cell to produce 35 bp reads. The
experimental design was therefore:</p>
<p><strong>Lane</strong> | <strong>Treatment</strong> | <strong>Label</strong>|
1 | Control | Con1|
2 | Control | Con2|
3 | Control | Con3|
4 | Control | Con4|
5 | DHT | DHT1|
6 | DHT | DHT2|
7 | DHT | DHT3|</p>
<p>This workflow requires raw gene count files and these can be generated
using a utility called featureCounts as demonstrated above. We are using
a pre-computed gene counts data (stored in <code class="codehilite"><span class="n">pnas_expression</span><span class="p">.</span><span class="n">txt</span></code>) for
this exercise.</p>
<h3 id="prepare-the-environment_1">Prepare the Environment</h3>
<p>Prepare the environment and load R:</p>
<p><div class="codehilite"><pre><span></span>    <span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">trainee</span><span class="o">/</span><span class="n">rnaseq</span><span class="o">/</span><span class="n">edgeR</span>
    <span class="n">R</span> <span class="p">(</span><span class="n">press</span> <span class="n">enter</span><span class="p">)</span>
</pre></div>
Once on the R prompt. Load libraries:
<div class="codehilite"><pre><span></span>    <span class="n">library</span><span class="p">(</span><span class="n">edgeR</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="n">biomaRt</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="n">gplots</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="ss">&quot;limma&quot;</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="ss">&quot;RColorBrewer&quot;</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="ss">&quot;org.Hs.eg.db&quot;</span><span class="p">)</span>
</pre></div></p>
<h3 id="read-in-data">Read in Data</h3>
<p>Read in count table and experimental design:
<div class="codehilite"><pre><span></span>    <span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">read.delim</span><span class="p">(</span><span class="s">&quot;pnas_expression.txt&quot;</span><span class="p">,</span> <span class="n">row.names</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">&lt;-</span> <span class="nf">read.delim</span><span class="p">(</span><span class="s">&quot;Targets.txt&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
    <span class="nf">colnames</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;-</span><span class="n">targets</span><span class="o">$</span><span class="n">Label</span>
    <span class="nf">head</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
</pre></div></p>
<h3 id="add-gene-annotation">Add Gene annotation</h3>
<p>The data set only includes the Ensembl gene id and the counts. It is
useful to have other annotations such as the gene symbol and entrez id.
Next we will add in these annotations. We will use the BiomaRt package
to do this.</p>
<p>We start by using the useMart function of BiomaRt to access the human
data base of ensemble gene ids.
<div class="codehilite"><pre><span></span>    <span class="n">human</span><span class="o">&lt;-</span><span class="nf">useMart</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;www.ensembl.org&quot;</span><span class="p">,</span> <span class="s">&quot;ENSEMBL_MART_ENSEMBL&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s">&quot;hsapiens_gene_ensembl&quot;</span><span class="p">)</span> 
    <span class="n">attributes</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;ensembl_gene_id&quot;</span><span class="p">,</span> <span class="s">&quot;entrezgene_id&quot;</span><span class="p">,</span><span class="s">&quot;hgnc_symbol&quot;</span><span class="p">)</span>
</pre></div>
We create a vector of our ensemble gene ids.
<div class="codehilite"><pre><span></span>    <span class="n">ensembl_names</span><span class="o">&lt;-</span><span class="nf">rownames</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nf">head</span><span class="p">(</span><span class="n">ensembl_names</span><span class="p">)</span>
</pre></div>
We then use the function getBM to get the gene symbol data we want.This
takes about a minute.
<div class="codehilite"><pre><span></span>    <span class="n">genemap</span><span class="o">&lt;-</span><span class="nf">getBM</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="s">&quot;ensembl_gene_id&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">ensembl_names</span><span class="p">,</span> <span class="n">mart</span><span class="o">=</span><span class="n">human</span><span class="p">)</span>
</pre></div>
Have a look at the start of the genemap dataframe.
<div class="codehilite"><pre><span></span>    <span class="n">head</span><span class="p">(</span><span class="n">genemap</span><span class="p">)</span>
</pre></div>
We then match the data we have retrieved to our dataset.
<div class="codehilite"><pre><span></span>    <span class="n">idx</span> <span class="o">&lt;-</span><span class="nf">match</span><span class="p">(</span><span class="n">ensembl_names</span><span class="p">,</span> <span class="n">genemap</span><span class="o">$</span><span class="n">ensembl_gene_id</span><span class="p">)</span>
    <span class="n">data</span><span class="o">$</span><span class="n">entrezgene</span> <span class="o">&lt;-</span><span class="n">genemap</span><span class="o">$</span><span class="n">entrezgene_id</span> <span class="n">[</span> <span class="n">idx</span> <span class="n">]</span>
    <span class="n">data</span><span class="o">$</span><span class="n">hgnc_symbol</span> <span class="o">&lt;-</span><span class="n">genemap</span><span class="o">$</span><span class="n">hgnc_symbol</span> <span class="n">[</span> <span class="n">idx</span> <span class="n">]</span>
    <span class="n">Ann</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="nf">rownames</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">$</span><span class="n">hgnc_symbol</span><span class="p">,</span> <span class="n">data</span><span class="o">$</span><span class="n">entrezgene</span><span class="p">)</span>
    <span class="nf">colnames</span><span class="p">(</span><span class="n">Ann</span><span class="p">)</span><span class="o">&lt;-</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Ensembl&quot;</span><span class="p">,</span> <span class="s">&quot;Symbol&quot;</span><span class="p">,</span> <span class="s">&quot;Entrez&quot;</span><span class="p">)</span>
    <span class="n">Ann</span><span class="o">&lt;-</span><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">Ann</span><span class="p">)</span>
</pre></div>
Let’s check and see that this additional information is there.
<div class="codehilite"><pre><span></span>    <span class="n">head</span><span class="p">(</span><span class="k">data</span><span class="p">)</span>
</pre></div></p>
<h3 id="data-checks">Data checks</h3>
<p>Create DGEList object:
<div class="codehilite"><pre><span></span>    <span class="n">treatment</span> <span class="o">&lt;-</span><span class="nf">factor</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="s">&quot;Control&quot;</span><span class="p">,</span><span class="m">4</span><span class="p">),</span> <span class="nf">rep</span><span class="p">(</span><span class="s">&quot;DHT&quot;</span><span class="p">,</span><span class="m">3</span><span class="p">)),</span> <span class="n">levels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Control&quot;</span><span class="p">,</span> <span class="s">&quot;DHT&quot;</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">&lt;-</span><span class="nf">DGEList</span><span class="p">(</span><span class="n">counts</span><span class="o">=</span><span class="n">data[</span><span class="p">,</span><span class="m">1</span><span class="o">:</span><span class="m">7</span><span class="n">]</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span> <span class="n">genes</span><span class="o">=</span><span class="n">Ann</span><span class="p">)</span>
</pre></div>
Check the dimensions of the object:
<div class="codehilite"><pre><span></span>    <span class="n">dim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
We see we have 37435 rows (i.e. genes) and 7 columns (samples).</p>
<div class="admonition note">
<p class="admonition-title">Question</p>
<div class="admonition hint">
<details><summary>Hint</summary><p><code class="codehilite"><span class="n">dim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></code> </p>
</details>
</div>
<div class="admonition success">
<p>16494</p>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Question</p>
<div class="admonition hint">
<details><summary>Hint</summary></details>
<p>do 37435-16494.</p>
</div>
<div class="admonition success"></div>
</div>
<p>As we have removed the lowly expressed genes the total number of counts
per sample has not changed greatly. Let us check the total number of
reads per sample in the original data (data) and now after filtering.</p>
<p>Before:
<div class="codehilite"><pre><span></span>    <span class="n">colSums</span><span class="p">(</span><span class="k">data</span><span class="p">[,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
</pre></div>
    After filtering:
<div class="codehilite"><pre><span></span>    <span class="n">colSums</span><span class="p">(</span><span class="n">y$counts</span><span class="p">)</span>
</pre></div>
We will now perform normalization to take account of different library
size:
<div class="codehilite"><pre><span></span>    <span class="n">y</span><span class="o">&lt;-</span><span class="nf">calcNormFactors</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
We will check the calculated normalization factors:
<div class="codehilite"><pre><span></span>    <span class="n">y$samples</span>
</pre></div>
Lets have a look at whether the samples cluster by condition. (You
should produce a plot as shown in Figure 4):</p>
<p><div class="codehilite"><pre><span></span>    <span class="n">plotMDS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="k">as</span><span class="p">.</span><span class="nb">numeric</span><span class="p">(</span><span class="n">y$samples$group</span><span class="p">))</span>
</pre></div>
<img alt="image" src="../MDS.png" /> [fig:MDS plot]</p>
<p>Does the MDS plot indicate a difference in gene expression between the
Controls and the DHT treated samples?</p>
<p>The MDS plot shows us that the controls are separated from the DHT
treated cells. This indicates that there is a difference in gene
expression between the conditions.</p>
<p>We will now estimate the dispersion. We start by estimating the common
dispersion. The common dispersion estimates the overall Biological
Coefficient of Variation (BCV) of the dataset averaged over all genes.</p>
<p>By using verbose we get the Disp and BCV values printed on the screen</p>
<p><div class="codehilite"><pre><span></span>    <span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">estimateCommonDisp</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
</pre></div>
What value to you see for BCV?</p>
<p>We now estimate gene-specific dispersion.
<div class="codehilite"><pre><span></span>    <span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">estimateTagwiseDisp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> 
</pre></div>
We will plot the tagwise dispersion and the common dispersion (You
should obtain a plot as shown in the Figure 5):
<div class="codehilite"><pre><span></span>    <span class="n">plotBCV</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
<img alt="image" src="../BCV.png" /> [fig:BCV plot]</p>
<p>We see here that the common dispersion estimates the overall Biological
Coefficient of Variation (BCV) of the dataset averaged over all genes.
The common dispersion is <code class="codehilite"><span class="mi">0</span><span class="p">.</span><span class="mi">02</span></code> and the BCV is the square root of the
common dispersion (sqrt[0.02] = 0.14). A BCV of 14% is typical for cell
line experiment.</p>
<p>As you can see from the plot the BCV of some genes (generally those with
low expression) can be much higher than the common dispersion. For
example we see genes with a reasonable level of expression with tagwise
dispersion of 0.4 indicating 40% variation between samples.</p>
<p>If we used the common dispersion for these genes instead of the tagwise
dispersion what effect would this have?</p>
<p>If we simply used the common dispersion for these genes we would
underestimate biological variability, which in turn affects whether
these genes would be identified as being differentially expressed
between conditions.It is recommended to use the tagwise dispersion,
which takes account of gene-to-gene variability.</p>
<p>Now that we have normalized our data and also calculated the variability
of gene expression between samples we are in a position to perform
differential expression testing.As this is a simple comparison between
two conditions, androgen treatment and placebo treatment we can use the
exact test for the negative binomial distribution (Robinson and Smyth,
2008).</p>
<h3 id="testing-for-differential-expression">Testing for Differential Expression</h3>
<p>We now test for differentially expressed BCV genes:
<div class="codehilite"><pre><span></span>    <span class="n">et</span> <span class="o">&lt;-</span> <span class="nf">exactTest</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
Now we will use the topTags function to adjust for multiple testing. We
will use the Benjimini Hochberg (&ldquo;BH&rdquo;) method and we will produce a
table of results:
<div class="codehilite"><pre><span></span>    <span class="n">res</span> <span class="o">&lt;-</span> <span class="nf">topTags</span><span class="p">(</span><span class="n">et</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="nf">nrow</span><span class="p">(</span><span class="n">y</span><span class="o">$</span><span class="n">counts</span><span class="p">),</span> <span class="n">adjust.method</span><span class="o">=</span><span class="s">&quot;BH&quot;</span><span class="p">)</span><span class="o">$</span><span class="n">table</span>
</pre></div>
Let’s have a look at the first rows of the table:
<div class="codehilite"><pre><span></span>    <span class="n">head</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
To get a summary of the number of differentially expressed genes we can
use the decideTestsDGE function.
<div class="codehilite"><pre><span></span>    <span class="nf">summary</span><span class="p">(</span><span class="n">de</span> <span class="o">&lt;-</span> <span class="nf">decideTestsDGE</span><span class="p">(</span><span class="n">et</span><span class="p">))</span>
</pre></div>
This tells us that 2096 genes are downregulated and 2339 genes are
upregulated at 5% FDR.We will now make subsets of the most significant
upregulated and downregulated genes.
<div class="codehilite"><pre><span></span>    <span class="n">alpha</span><span class="o">=</span><span class="m">0.05</span>
    <span class="n">lfc</span><span class="o">=</span><span class="m">1.5</span>
    <span class="n">edgeR_res_sig</span><span class="o">&lt;-</span><span class="n">res[res</span><span class="o">$</span><span class="n">FDR</span><span class="o">&lt;</span><span class="n">alpha</span><span class="p">,</span><span class="n">]</span>
    <span class="n">edgeR_res_sig_lfc</span> <span class="o">&lt;-</span><span class="n">edgeR_res_sig</span><span class="nf">[abs</span><span class="p">(</span><span class="n">edgeR_res_sig</span><span class="o">$</span><span class="n">logFC</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lfc</span><span class="p">,</span><span class="n">]</span>
    <span class="nf">head</span><span class="p">(</span><span class="n">edgeR_res_sig</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="m">20</span><span class="p">)</span><span class="nf">nrow</span><span class="p">(</span><span class="n">edgeR_res_sig</span><span class="p">)</span><span class="nf">nrow</span><span class="p">(</span><span class="n">edgeR_res_sig_lfc</span><span class="p">)</span>
</pre></div>
We can write out these results to our current directory.</p>
<div class="admonition note">
<p class="admonition-title">Question</p>
<p>How many differentially expressed genes are there?</p>
<div class="admonition success">
<p>4435</p>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Question</p>
<div class="admonition hint">
<details><summary>Hint</summary></details>
</div>
<div class="admonition success">
<p>2339 2096</p>
</div>
</div>
<p>If you need to quit the <code class="codehilite"><span class="n">R</span></code> console, type:
<code class="codehilite"><span class="n">q</span><span class="p">()</span></code>
You can save your workspace by typing <code class="codehilite"><span class="n">Y</span></code> on prompt.</p>
<p>Please note that the output files you are creating are saved in your
present working directory. If you are not sure where you are in the file
system try typing <code class="codehilite"><span class="n">pwd</span></code> on your command prompt to find out.</p>
<h2 id="references">References</h2>
<ol>
<li>
<p>Trapnell, C., Pachter, L. &amp; Salzberg, S. L. TopHat: discovering
    splice junctions with RNA-Seq. Bioinformatics 25, 1105-1111 (2009).</p>
</li>
<li>
<p>Trapnell, C. et al. Transcript assembly and quantification by
    RNA-Seq reveals unannotated transcripts and isoform switching during
    cell differentiation. Nat. Biotechnol. 28, 511-515 (2010).</p>
</li>
<li>
<p>Langmead, B., Trapnell, C., Pop, M. &amp; Salzberg, S. L. Ultrafast and
    memory-efficient alignment of short DNA sequences to the human
    genome. Genome Biol. 10, R25 (2009).</p>
</li>
<li>
<p>Roberts, A., Pimentel, H., Trapnell, C. &amp; Pachter, L. Identification
    of novel transcripts in annotated genomes using RNA-Seq.
    Bioinformatics 27, 2325-2329 (2011).</p>
</li>
<li>
<p>Roberts, A., Trapnell, C., Donaghey, J., Rinn, J. L. &amp; Pachter, L.
    Improving RNA-Seq expression estimates by correcting for fragment
    bias. Genome Biol. 12, R22 (2011).</p>
</li>
<li>
<p>Robinson MD, McCarthy DJ and Smyth GK. edgeR: a Bioconductor package
    for differential expression analysis of digital gene expression
    data. Bioinformatics, 26 (2010).</p>
</li>
<li>
<p>Robinson MD and Smyth GK Moderated statistical tests for assessing
    differences in tag abundance. Bioinformatics, 23, pp. -6.</p>
</li>
<li>
<p>Robinson MD and Smyth GK (2008). Small-sample estimation of negative
    binomial dispersion, with applications to SAGE data.” Biostatistics,
    9.</p>
</li>
<li>
<p>McCarthy, J. D, Chen, Yunshun, Smyth and K. G (2012). Differential
    expression analysis of multifactor RNA-Seq experiments with respect
    to biological variation. Nucleic Acids Research, 40(10), pp. -9.</p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../../alignment/handout/handout/" title="Read Alignment" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Read Alignment
              </span>
            </div>
          </a>
        
        
          <a href="../../../denovo/handout/handout/" title="De Novo Genome Assembly" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                De Novo Genome Assembly
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; The authors; 2019-
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
        <script src="../../../js/details.js"></script>
      
    
  </body>
</html>